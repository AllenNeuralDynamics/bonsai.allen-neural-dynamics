<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title> </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content=" ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/AllenNeuralDynamics/Bonsai.AllenNeuralDynamics/blob/main/docs/harp_devices_spec/Harp_LicketySplit.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="Harp.LicketySplit">

<p>An ephys-compliant lick detector based on measured change in capacitance.</p>
<h2 id="features">Features</h2>
<ul>
<li>High Frequency (100 or 125 [KHz]), low current (200[nA]) excitation signal makes this device invisible to <a href="https://www.neuropixels.org/">Neuropixel Probes</a> used in electrophysiology recordings.</li>
<li>Fast. &lt; 1[ms] response time.</li>
<li>Contact-based. Device triggers when mouse tongue contacts either the dispensing tube <em>or</em> dangling reward liquid.</li>
<li>TTL output triggers when a lick is detected.</li>
<li>Harp-protocol compliant (serial num: 0x0578). Also dispatches timestamped Harp messages when lick state change has changed.</li>
<li>Fully supported in Bonsai with a dedicated <a href="https://www.nuget.org/packages/AllenNeuralDynamics.LicketySplitLickDetector">Bonsai package</a></li>
</ul>
<h3 id="extra-features">Extra Features</h3>
<ul>
<li>6-20VDC input (2.1 x 5.5mm barrel jack, positive center)</li>
<li>reverse-polarity protected</li>
<li>isolated USB to prevent ground loops with the PC.</li>
<li>Two frequency options: 100 and 125[KHz] signal frequency to eliminate crosstalk between two closely-spaced lick tubes.</li>
<li>Two amplitude options:
<ul>
<li>The 0.02[Vpp] option with proper grounding is intended for Ephys recordings as it introduces negligible noise artifacts.</li>
<li>The 2[Vpp] option can be used outside of an Ephys context without a ground connection</li>
</ul>
</li>
</ul>
<h2 id="device-pinout">Device Pinout</h2>
<p><img src="../harp_devices_src/harp.device.lickety-split/notes/images/pinout.png" alt="Pinout"></p>
<h2 id="ephys-wiring-diagram">Ephys Wiring Diagram</h2>
<p>There are 3 configurations that will produce valid lick detection readings:</p>
<p>Option A works well if your rig does not have large sources of 60Hz noise.</p>
<p><img src="../harp_devices_src/harp.device.lickety-split/notes/images/setup_a.png" alt="SetupA"></p>
<p>Option B works well if your rig <em>does</em> have large sources of 60Hz noise.</p>
<p><img src="../harp_devices_src/harp.device.lickety-split/notes/images/setup_b.png" alt="SetupB"></p>
<p>Option C works well if your rig <em>does</em> have large sources of 60Hz noise, but you cannot earth ground it.</p>
<p><img src="../harp_devices_src/harp.device.lickety-split/notes/images/setup_c.png" alt="SetupC"></p>
<h3 id="cables">Cables</h3>
<p>This system uses a Triax cable and will work with cable lengths up to .8 meters (2.5 ft) long.
Triax cables can be purchased mostly-assembled from this eBay seller <a href="https://www.ebay.com/itm/225796046481">here</a> and then modified slightly to connect to your lick port.</p>
<h2 id="warnings">Warnings</h2>
<h3 id="electrical-setup">Electrical Setup</h3>
<p>It is critical that (1) both the device and mouse under test are grounded to a common ground and
(2) the rig is earth-grounded (i.e: any exposed metal components are connected to earth ground).
Otherwise, the device may introduce noise on the Neuropixel probes or produce spurious licks from outside electromagnetic interference.</p>
<h3 id="multiple-lick-detector-crosstalk">Multiple-Lick-Detector Crosstalk</h3>
<p>Multiple lick detectors can be used in the same setup provided that (1) they are grounded correctly (see <em>Electrical Setup</em>), (2) the lick tubes are electrically insulated relative to each other, and (3) the spacing between exposed lick tubes exceeds 4mm.
If the spacing between exposed metal lick tubes is less than 4mm, then the antenna noise from one lick detector may affect the other.
This phenomenon is called <em>crosstalk</em>, and it can appear in 2 ways.</p>
<ol>
<li>Lick signals that appear on one detector may show up on both detectors. The system is useable in this case, but the data may need to be cleaned up in post-processing where the shorter &quot;simultaneously&quot; detected lick is thrown out.</li>
<li>The amplitudes of the two AC signals will constructively interfere with each other, causing the excitation signals to saturate to their maximum values. The system cannot be used to detect licks this way.</li>
</ol>
<p>To fix this issue,</p>
<ol>
<li>Put each lick detector on a different frequency (100KHz and 125KHz).</li>
<li>Space the lick detection tubes farther apart.</li>
<li>Reduce the length of exposed metal on the lick tube.</li>
</ol>
<h2 id="theory-of-operation">Theory of Operation</h2>
<p>This device detects a threshold change in capacitance.
A 100KHz, 10mVpp AC sine wave is played on the tip of a conductive lick spout,
(such as McMaster-Carr pn: <a href="https://www.mcmaster.com/catalog/129/184/89875K271">89875K271</a>), and the amplitude of the returned waveform is measured every period.</p>
<p>A mouse sharing a ground with this device presents itself as a series resitive and capacitive load.
When the mouse's tongue touches the metal tube (or water on the tip of the metal tube), the AC signal passes through the mouse to ground, lowering the amplitude of the returned sine wave below its trigger value, which triggers a lick to be detected.
This detection signal is bandpassed in hardware (4th order Butterworth) and the resulting detection signal is lowpassed and compared against a threshold value in firmware to produce a lick/no-lick external trigger output.
Overall propagation time through the entire signal chain is less than 1 millisecond.</p>
<p>The detection signal is AC such that repeated contact with the lick tube does not slowly charge the mouse.</p>
<h2 id="tuning-parameters">Tuning Parameters</h2>
<p><strong>Warning:</strong> changing the values of these tuning parameters may produce a detection signal that exceeds the &lt;1[ms] detection time guarantee.
We suggest ensuring that your setup is electrically grounded correctly first before changing these values.</p>
<p>There are three parameters that can be adjusted related to tuning the lick detection sensitivity.
While the starting values should be sufficient for almost all setups, it is (unlikely but) possible that these knobs may need to be adjusted for a particular setup.
The four parameters are:</p>
<ul>
<li>&quot;fast moving average&quot; window size
<ul>
<li>the last <em>N</em> raw signal amplitude values are averaged and sent to the consensus filter.</li>
<li>This filter smooths out high frequency amplitude changes by averaging the last few values together.</li>
<li>constraint: <em>N</em> must be a power of 2 (i.e: 2, 4, 8, 16, ...).</li>
</ul>
</li>
<li>&quot;consensus&quot; filter window size
<ul>
<li>the last <em>N</em> values must all be below the <em>lick-detection start</em> threshold to trigger a detected lick.</li>
<li>This filter increases the system's ability to reject intermittent (most likely inductive) noise sources that shrink the signal amplitude for a small period of time and may appear as a lick. Noise sources include fans, valves, and other lick detection tubes placed closer than 4mm apart.</li>
<li>Increasing this value will improve the system's ability to reject outside inductive noise, but will slow down the detection time.</li>
<li>constraint: <em>N</em> must be a power of 2.</li>
</ul>
</li>
<li>lick-detection &quot;start&quot; threshold
<ul>
<li>a signal value below this threshold will trigger a detected lick (i.e: the output signal will be set to 5V.)</li>
<li>constraint: &quot;start&quot; &lt; &quot;stop&quot; threshold</li>
</ul>
</li>
<li>lick-detection &quot;stop&quot; threshold
<ul>
<li>a signal value above threshold will untrigger a detected lick (i.e: the output signal will be set to 0V.)</li>
<li>constraint: &quot;start&quot; &lt; &quot;stop&quot; threshold</li>
</ul>
</li>
</ul>
<table>
  <thead>
    <tr><th colspan="2">LicketySplit</th></tr>
  </thead>
  <tbody>
    <tr><td>whoAmI</td><td>1400</td></tr>
    <tr><td>firmwareVersion</td><td>0.0</td></tr>
    <tr><td>hardwareTargets</td><td>0.5</td></tr>
  </tbody>
</table>
<h3 id="registers">Registers</h3>
<table>
<thead>
<tr>
<th>name</th>
<th>address</th>
<th>type</th>
<th>length</th>
<th>access</th>
<th>description</th>
<th>range</th>
<th>interfaceType</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="xref:Harp.LicketySplit.LickState">LickState</a></td>
<td>32</td>
<td>U8</td>
<td></td>
<td>Event</td>
<td>Emits an event when the state of any lick detector changes. Value will be High when lick detected and Low otherwise.</td>
<td></td>
<td><a href="xref:Harp.LicketySplit.LickChannels">LickChannels</a></td>
</tr>
<tr>
<td><a href="xref:Harp.LicketySplit.Channel0TriggerThreshold">Channel0TriggerThreshold</a></td>
<td>33</td>
<td>U8</td>
<td></td>
<td>Write</td>
<td>Threshold value to detect the lick. Values below this threshold will be considered a detected lick.</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="xref:Harp.LicketySplit.Channel0UntriggerThreshold">Channel0UntriggerThreshold</a></td>
<td>34</td>
<td>U8</td>
<td></td>
<td>Write</td>
<td>Threshold value to release the lick detection state. Values above this threshold will untrigger a detected lick.</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/AllenNeuralDynamics/Bonsai.AllenNeuralDynamics/blob/main/docs/harp_devices_spec/Harp_LicketySplit.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
